{"version":3,"sources":["../../../src/internal-plugins/functions/gatsby-node.ts"],"names":["isProductionEnv","process","env","gatsby_executing_command","activeDevelopmentFunctions","Set","activeEntries","ensureFunctionIsCompiled","functionObj","compiledFunctionsDir","compiledFileExists","fs","stat","absoluteCompiledFilePath","e","time","Date","utimesSync","originalAbsoluteFilePath","Promise","resolve","watcher","chokidar","watch","on","_path","close","createGlobArray","siteDirectoryPath","plugins","globs","push","globPattern","rootPath","path","join","pluginName","forEach","plugin","name","includes","glob","_","union","globAsync","pattern","options","reject","err","files","createWebpackConfig","functionsDirectory","store","reporter","getState","flattenedPlugins","allFunctions","all","map","knownFunctions","file","originalRelativeFilePath","relative","dir","parse","compiledFunctionName","compiledPath","finalName","functionRoute","relativeCompiledFilePath","matchPath","unionBy","func","dispatch","internalActions","setFunctions","writeFileSync","JSON","stringify","nodeEnv","NODE_ENV","defaultNodeEnv","configEnv","GATSBY_ACTIVE_ENV","envFile","parsed","dotenv","readFileSync","encoding","code","report","error","envObject","Object","keys","reduce","acc","key","varsFromProcessEnv","PUBLIC_DIR","mergedEnvVars","assign","processEnvVars","entries","functionsList","parsedFile","compiledNameWithoutExtension","stage","config","entry","output","filename","libraryTarget","target","optimization","minimize","extensions","cache","type","cacheLocation","mode","module","rules","test","exclude","use","loader","presets","webpack","DefinePlugin","isFirstBuild","onPreBootstrap","activity","activityTimer","start","program","directory","functionsDirectoryPath","verbose","ensureDir","emptyDir","callback","stats","rawMessages","toJson","moduleTrace","warnings","length","errors","compilation","formated","message","success","run","compiler","ignoreInitial","event","values","log","panic","end","onCreateDevServer","app","any","express","urlencoded","extended","req","res","next","cookies","headers","cookie","text","json","raw","pathFragment","params","functions","find","some","f","exp","exec","matches","match","slice","newParams","index","add","now","pathToFunction","require","fn","fnToExecute","default","headersSent","status","send"],"mappings":"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","sourcesContent":["import fs from \"fs-extra\"\nimport glob from \"glob\"\nimport path from \"path\"\nimport webpack from \"webpack\"\nimport _ from \"lodash\"\nimport multer from \"multer\"\nimport * as express from \"express\"\nimport { urlResolve, getMatchPath } from \"gatsby-core-utils\"\nimport { ParentSpanPluginArgs, CreateDevServerArgs } from \"gatsby\"\nimport { internalActions } from \"../../redux/actions\"\nimport { reportWebpackWarnings } from \"../../utils/webpack-error-utils\"\nimport formatWebpackMessages from \"react-dev-utils/formatWebpackMessages\"\nimport dotenv from \"dotenv\"\nimport chokidar from \"chokidar\"\nimport pathToRegexp from \"path-to-regexp\"\nimport cookie from \"cookie\"\n\nconst isProductionEnv = process.env.gatsby_executing_command !== `develop`\n\ninterface IFunctionData {\n  /** The route in the browser to access the function **/\n  functionRoute: string\n  /** The absolute path to the original function **/\n  originalAbsoluteFilePath: string\n  /** The relative path to the original function **/\n  originalRelativeFilePath: string\n  /** The relative path to the compiled function (always ends with .js) **/\n  relativeCompiledFilePath: string\n  /** The absolute path to the compiled function (doesn't transfer across machines) **/\n  absoluteCompiledFilePath: string\n  /** The matchPath regex created by path-to-regexp. Only created if the function is dynamic. **/\n  matchPath: string\n  /** The plugin that owns this function route **/\n  pluginName: string\n}\n\ninterface IGlobPattern {\n  /** The plugin that owns this namespace **/\n  pluginName: string\n  /** The root path to the functions **/\n  rootPath: string\n  /** The glob pattern **/\n  globPattern: string\n}\n\n// During development, we lazily compile functions only when they're requested.\n// Here we keep track of which functions have been requested so are \"active\"\nconst activeDevelopmentFunctions = new Set<IFunctionData>()\nlet activeEntries = {}\n\nasync function ensureFunctionIsCompiled(\n  functionObj: IFunctionData,\n  compiledFunctionsDir: string\n): any {\n  // stat the compiled function. If it's there, then return.\n  let compiledFileExists = false\n  try {\n    compiledFileExists = !!(await fs.stat(functionObj.absoluteCompiledFilePath))\n  } catch (e) {\n    // ignore\n  }\n  if (compiledFileExists) {\n    return\n  } else {\n    // Otherwise, restart webpack by touching the file and watch for the file to be\n    // compiled.\n    const time = new Date()\n    fs.utimesSync(functionObj.originalAbsoluteFilePath, time, time)\n    await new Promise(resolve => {\n      const watcher = chokidar\n        // Watch the root of the compiled function directory in .cache as chokidar\n        // can't watch files in directories that don't yet exist.\n        .watch(compiledFunctionsDir)\n        .on(`add`, async _path => {\n          if (_path === functionObj.absoluteCompiledFilePath) {\n            await watcher.close()\n\n            resolve(null)\n          }\n        })\n    })\n  }\n}\n\n// Create glob type w/ glob, plugin name, root path\nconst createGlobArray = (siteDirectoryPath, plugins): Array<IGlobPattern> => {\n  const globs: Array<IGlobPattern> = []\n\n  // Add the default site src/api directory.\n  globs.push({\n    globPattern: `${siteDirectoryPath}/src/api/**/*.{js,ts}`,\n    rootPath: path.join(siteDirectoryPath, `src/api`),\n    pluginName: `default-site-plugin`,\n  })\n\n  // Add each plugin\n  plugins.forEach(plugin => {\n    // Ignore the \"default\" site plugin (aka the src tree) as we're\n    // already watching that.\n    if (plugin.name === `default-site-plugin`) {\n      return\n    }\n    // Ignore any plugins we include by default. In the very unlikely case\n    // we want to ship default functions, we'll special case add them. In the\n    // meantime, we'll avoid extra FS IO.\n    if (plugin.resolve.includes(`internal-plugin`)) {\n      return\n    }\n    if (plugin.resolve.includes(`gatsby-plugin-typescript`)) {\n      return\n    }\n    if (plugin.resolve.includes(`gatsby-plugin-page-creator`)) {\n      return\n    }\n\n    const glob = {\n      globPattern: `${plugin.resolve}/src/api/${plugin.name}/**/*.{js,ts}`,\n      rootPath: path.join(plugin.resolve, `src/api`),\n      pluginName: plugin.name,\n    } as IGlobPattern\n    globs.push(glob)\n  })\n\n  // Only return unique paths\n  return _.union(globs)\n}\n\nasync function globAsync(pattern, options): Promise<Array<string>> {\n  return await new Promise((resolve, reject) => {\n    glob(pattern, options, (err, files) => {\n      if (err) {\n        reject(err)\n      } else {\n        resolve(files)\n      }\n    })\n  })\n}\n\nconst createWebpackConfig = async ({\n  siteDirectoryPath,\n  functionsDirectory,\n  store,\n  reporter,\n}): Promise<webpack.Configuration> => {\n  const compiledFunctionsDir = path.join(\n    siteDirectoryPath,\n    `.cache`,\n    `functions`\n  )\n\n  const globs = createGlobArray(\n    siteDirectoryPath,\n    store.getState().flattenedPlugins\n  )\n\n  // Glob and return object with relative/absolute paths + which plugin\n  // they belong to.\n  const allFunctions = await Promise.all(\n    globs.map(async glob => {\n      const knownFunctions: Array<IFunctionData> = []\n      const files = await globAsync(glob.globPattern)\n      files.map(file => {\n        const originalAbsoluteFilePath = file\n        const originalRelativeFilePath = path.relative(glob.rootPath, file)\n\n        const { dir, name } = path.parse(originalRelativeFilePath)\n        // Ignore the original extension as all compiled functions now end with js.\n        const compiledFunctionName = path.join(dir, name + `.js`)\n        const compiledPath = path.join(\n          compiledFunctionsDir,\n          compiledFunctionName\n        )\n        const finalName = urlResolve(dir, name === `index` ? `` : name)\n\n        knownFunctions.push({\n          functionRoute: finalName,\n          pluginName: glob.pluginName,\n          originalAbsoluteFilePath,\n          originalRelativeFilePath,\n          relativeCompiledFilePath: compiledFunctionName,\n          absoluteCompiledFilePath: compiledPath,\n          matchPath: getMatchPath(finalName),\n        })\n      })\n\n      return knownFunctions\n    })\n  )\n\n  // Combine functions by the route name so that functions in the default\n  // functions directory can override the plugin's implementations.\n  const knownFunctions = _.unionBy(\n    ...allFunctions,\n    func => func.functionRoute\n  ) as Array<IFunctionData>\n\n  store.dispatch(internalActions.setFunctions(knownFunctions))\n\n  // Write out manifest for use by `gatsby serve` and plugins\n  fs.writeFileSync(\n    path.join(compiledFunctionsDir, `manifest.json`),\n    JSON.stringify(knownFunctions, null, 4)\n  )\n\n  // Load environment variables from process.env.GATSBY_* and .env.* files.\n  // Logic is shared with webpack.config.js\n\n  // node env should be DEVELOPMENT | PRODUCTION as these are commonly used in node land\n  const nodeEnv = process.env.NODE_ENV || `${defaultNodeEnv}`\n  // config env is dependent on the env that it's run, this can be anything from staging-production\n  // this allows you to set use different .env environments or conditions in gatsby files\n  const configEnv = process.env.GATSBY_ACTIVE_ENV || nodeEnv\n  const envFile = path.join(siteDirectoryPath, `./.env.${configEnv}`)\n  let parsed = {}\n  try {\n    parsed = dotenv.parse(fs.readFileSync(envFile, { encoding: `utf8` }))\n  } catch (err) {\n    if (err.code !== `ENOENT`) {\n      report.error(\n        `There was a problem processing the .env file (${envFile})`,\n        err\n      )\n    }\n  }\n\n  const envObject = Object.keys(parsed).reduce((acc, key) => {\n    acc[key] = JSON.stringify(parsed[key])\n    return acc\n  }, {})\n\n  const varsFromProcessEnv = Object.keys(process.env).reduce((acc, key) => {\n    acc[key] = JSON.stringify(process.env[key])\n    return acc\n  }, {})\n\n  // Don't allow overwriting of NODE_ENV, PUBLIC_DIR as to not break gatsby things\n  envObject.NODE_ENV = JSON.stringify(nodeEnv)\n  envObject.PUBLIC_DIR = JSON.stringify(`${siteDirectoryPath}/public`)\n\n  const mergedEnvVars = Object.assign(envObject, varsFromProcessEnv)\n\n  const processEnvVars = Object.keys(mergedEnvVars).reduce(\n    (acc, key) => {\n      acc[`process.env.${key}`] = mergedEnvVars[key]\n      return acc\n    },\n    {\n      \"process.env\": `({})`,\n    }\n  )\n\n  const entries = {}\n  const functionsList = isProductionEnv\n    ? knownFunctions\n    : activeDevelopmentFunctions\n  functionsList.forEach(functionObj => {\n    // Get path without the extension (as it could be ts or js)\n    const parsedFile = path.parse(functionObj.originalRelativeFilePath)\n    const compiledNameWithoutExtension = path.join(\n      parsedFile.dir,\n      parsedFile.name\n    )\n\n    entries[compiledNameWithoutExtension] = functionObj.originalAbsoluteFilePath\n  })\n\n  activeEntries = entries\n\n  const stage = isProductionEnv\n    ? `functions-production`\n    : `functions-development`\n\n  const config = {\n    entry: entries,\n    output: {\n      path: compiledFunctionsDir,\n      filename: `[name].js`,\n      libraryTarget: `commonjs2`,\n    },\n    target: `node`,\n\n    // Minification is expensive and not as helpful for serverless functions.\n    optimization: {\n      minimize: false,\n    },\n\n    // Resolve files ending with .ts and the default extensions of .js, .json, .wasm\n    resolve: {\n      extensions: [`.ts`, `...`],\n    },\n\n    // Have webpack save its cache to the .cache/webpack directory\n    cache: {\n      type: `filesystem`,\n      name: stage,\n      cacheLocation: path.join(\n        siteDirectoryPath,\n        `.cache`,\n        `webpack`,\n        `stage-` + stage\n      ),\n    },\n\n    mode: isProductionEnv ? `production` : `development`,\n    // watch: !isProductionEnv,\n    module: {\n      rules: [\n        {\n          test: [/.js$/, /.ts$/],\n          exclude: /node_modules/,\n          use: {\n            loader: `babel-loader`,\n            options: {\n              presets: [`@babel/typescript`],\n            },\n          },\n        },\n      ],\n    },\n    plugins: [new webpack.DefinePlugin(processEnvVars)],\n  }\n\n  return config\n}\n\nlet isFirstBuild = true\nexport async function onPreBootstrap({\n  reporter,\n  store,\n}: ParentSpanPluginArgs): Promise<void> {\n  const activity = reporter.activityTimer(`Compiling Gatsby Functions`)\n  activity.start()\n\n  const {\n    program: { directory: siteDirectoryPath },\n  } = store.getState()\n\n  const functionsDirectoryPath = path.join(siteDirectoryPath, `src/api`)\n\n  const functionsDirectory = path.resolve(\n    siteDirectoryPath,\n    functionsDirectoryPath as string\n  )\n\n  reporter.verbose(`Attaching functions to development server`)\n  const compiledFunctionsDir = path.join(\n    siteDirectoryPath,\n    `.cache`,\n    `functions`\n  )\n\n  await fs.ensureDir(compiledFunctionsDir)\n  await fs.emptyDir(compiledFunctionsDir)\n\n  try {\n    // We do this ungainly thing as we need to make accessible\n    // the resolve/reject functions to our shared callback function\n    // eslint-disable-next-line\n    await new Promise(async (resolve, reject) => {\n      const config = await createWebpackConfig({\n        siteDirectoryPath,\n        functionsDirectory,\n        store,\n        reporter,\n      })\n\n      function callback(err, stats): any {\n        const rawMessages = stats.toJson({ moduleTrace: false })\n        if (rawMessages.warnings.length > 0) {\n          reportWebpackWarnings(rawMessages.warnings, reporter)\n        }\n\n        if (err) return reject(err)\n        const errors = stats.compilation.errors || []\n\n        // If there's errors, reject in production and print to the console\n        // in development.\n        if (isProductionEnv) {\n          if (errors.length > 0) return reject(stats.compilation.errors)\n        } else {\n          const formated = formatWebpackMessages({\n            errors: rawMessages.errors.map(e => e.message),\n            warnings: [],\n          })\n          reporter.error(formated.errors)\n        }\n\n        // Log success in dev\n        if (!isProductionEnv) {\n          if (isFirstBuild) {\n            isFirstBuild = false\n          } else {\n            reporter.success(`Re-building functions`)\n          }\n        }\n\n        return resolve(null)\n      }\n\n      if (isProductionEnv) {\n        webpack(config).run(callback)\n      } else {\n        // When in watch mode, you call things differently\n        let compiler = webpack(config).watch({}, callback)\n\n        const globs = createGlobArray(\n          siteDirectoryPath,\n          store.getState().flattenedPlugins\n        )\n\n        // Watch for env files to change and restart the webpack watcher.\n        chokidar\n          .watch(\n            [\n              `${siteDirectoryPath}/.env*`,\n              ...globs.map(glob => glob.globPattern),\n            ],\n            { ignoreInitial: true }\n          )\n          .on(`all`, async (event, path) => {\n            // Ignore change events from the API directory for functions we're\n            // already watching.\n            if (\n              event === `change` &&\n              Object.values(activeEntries).includes(path) &&\n              path.includes(`/src/api/`)\n            ) {\n              return\n            }\n\n            reporter.log(\n              `Restarting function watcher due to change to \"${path}\"`\n            )\n\n            // Otherwise, restart the watcher\n            compiler.close(async () => {\n              const config = await createWebpackConfig({\n                siteDirectoryPath,\n                functionsDirectory,\n                store,\n                reporter,\n              })\n              compiler = webpack(config).watch({}, callback)\n            })\n          })\n      }\n    })\n  } catch (e) {\n    activity.panic(`Failed to compile Gatsby Functions.`, e)\n  }\n\n  activity.end()\n}\n\nexport async function onCreateDevServer({\n  reporter,\n  app,\n  store,\n}: CreateDevServerArgs): Promise<void> {\n  reporter.verbose(`Attaching functions to development server`)\n\n  const {\n    program: { directory: siteDirectoryPath },\n  } = store.getState()\n\n  const compiledFunctionsDir = path.join(\n    siteDirectoryPath,\n    `.cache`,\n    `functions`\n  )\n\n  app.use(\n    `/api/*`,\n    multer().any(),\n    express.urlencoded({ extended: true }),\n    (req, res, next) => {\n      const cookies = req.headers.cookie\n\n      if (!cookies) {\n        return next()\n      }\n\n      req.cookies = cookie.parse(cookies)\n\n      return next()\n    },\n    express.text(),\n    express.json(),\n    express.raw(),\n    async (req, res, next) => {\n      const { \"0\": pathFragment } = req.params\n\n      const {\n        functions,\n      }: { functions: Array<IFunctionData> } = store.getState()\n\n      // Check first for exact matches.\n      let functionObj = functions.find(\n        ({ functionRoute }) => functionRoute === pathFragment\n      )\n\n      if (!functionObj) {\n        // Check if there's any matchPaths that match.\n        // We loop until we find the first match.\n        functions.some(f => {\n          let exp\n          const keys = []\n          if (f.matchPath) {\n            exp = pathToRegexp(f.matchPath, keys)\n          }\n          if (exp && exp.exec(pathFragment) !== null) {\n            functionObj = f\n            const matches = [...pathFragment.match(exp)].slice(1)\n            const newParams = {}\n            matches.forEach(\n              (match, index) => (newParams[keys[index].name] = match)\n            )\n            req.params = newParams\n\n            return true\n          } else {\n            return false\n          }\n        })\n      }\n\n      if (functionObj) {\n        activeDevelopmentFunctions.add(functionObj)\n\n        await ensureFunctionIsCompiled(functionObj, compiledFunctionsDir)\n\n        reporter.verbose(`Running ${functionObj.functionRoute}`)\n        const start = Date.now()\n        const pathToFunction = functionObj.absoluteCompiledFilePath\n\n        try {\n          delete require.cache[require.resolve(pathToFunction)]\n          const fn = require(pathToFunction)\n\n          const fnToExecute = (fn && fn.default) || fn\n\n          await Promise.resolve(fnToExecute(req, res))\n        } catch (e) {\n          // Override the default error with something more specific.\n          if (e.message.includes(`fnToExecute is not a function`)) {\n            e.message = `${functionObj.originalAbsoluteFilePath} does not export a function.`\n          }\n          reporter.error(e)\n          // Don't send the error if that would cause another error.\n          if (!res.headersSent) {\n            res\n              .status(500)\n              .send(\n                `Error when executing function \"${functionObj.originalAbsoluteFilePath}\":<br /><br />${e.message}`\n              )\n          }\n        }\n\n        const end = Date.now()\n        reporter.log(\n          `Executed function \"/api/${functionObj.functionRoute}\" in ${\n            end - start\n          }ms`\n        )\n      } else {\n        next()\n      }\n    }\n  )\n}\n"],"file":"gatsby-node.js"}